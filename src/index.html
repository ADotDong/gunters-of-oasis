{% set ROOT = IS_HOME and '' or '../' %}
{% from './templates/portal.html' import portal %}

<html>
  <head>
    <title>OASIS</title>
    <link rel="shortcut icon" href="{{ ROOT }}assets/img/favicon.png" type="image/x-icon">
    <script src="https://rawgit.com/aframevr/aframe/4d90df5/dist/aframe-master.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.min.js"></script>
    <script src="https://shy-teeth.glitch.me/easyrtc/easyrtc.js"></script>
    <script src="{{ ROOT }}build/build.js"></script>
    {% if IS_PRODUCTION %}<style>.a-inspector-loader{ display: none; }</style>{% endif %}
    <style>
      html { background: #111; }
    </style>
  </head>
  <body>
    <audio id="audio" src="{{ IS_HOME and 'assets/audio/worldinmyeyes.mp3' or song }}" autoplay></audio>
    <script>document.getElementById('audio').volume = 0.25;</script>

    <a-scene debug-controller="enabled: true" environment="{{ environment or 'preset: tron' }}" teleport-refresh networked-scene="serverURL: shy-teeth.glitch.me; room: {{ seed or 'default' }}; debug: true">
      <a-assets>
        <img id="shadowImg" src="{{ ROOT }}assets/img/shadow.png">
        <img id="sliceImg" src="{{ ROOT }}assets/img/slice.png">
        {% if IS_HOME %}
          <img id="logo" src="{{ ROOT }}assets/img/logo.png">
        {% endif %}
        {% if IS_GOAL %}
          <img src="{{ ROOT }}assets/img/envmap.jpg" id="envmapImg">
          <img src="{{ ROOT }}assets/img/grad.png" id="gradImg">
        {% endif %}

        <a-mixin id="slice" slice9="color: #050505; src: #sliceImg; left: 50; right: 52; top: 50; bottom: 52; padding: 0.04"></a-mixin>

        <a-mixin id="hand"
          teleport-controls="type: line; collisionEntities: [mixin~=portal], .environmentGround; cameraRig: #cameraRig; teleportOrigin: #camera; startEvents: triggerdown; endEvents: triggerup; landingMaxAngle: 360; hitCylinderColor: #e6e8e6; curveHitColor: #e6e8e6; hitCylinderHeight: 0.05; checkCollisionChildren: false"
          teleport-listener
        ></a-mixin>

        <a-mixin id="portal"
          animation__mouseenter="property: components.material.material.uniforms.strokeColor.value; type: color; from: #113; to: #DDE; startEvents: mouseenter; easing: easeInOutCubic; dur: 200"
          animation__mouseleave="property: components.material.material.uniforms.strokeColor.value; type: color; from: #DDE; to: #113; startEvents: mouseleave; easing: easeInOutCubic; dur: 200"
          look-at="#camera"
          geometry="primitive: circle; segments: 40"
          material="shader: oasisPortal; backgroundColor: #333; strokeColor: #113"
          raycastable></a-mixin>
        <a-mixin id="hoverAnimation"
          animation="property: object3D.position.y; from: 1.6; to: 1.8; dir: alternate; loop: true; dur: 5000; easing: easeInOutCubic"></a-mxiin>

        {% include './templates/avatar.html' %}
      </a-assets>

      {% if IS_HOME %}
        <a-entity
          animation="property: object3D.position.y; from: 10; to: 11; dir: alternate; loop: true; dur: 8000; easing: easeInOutCubic"
          geometry="primitive: plane; width: 8; height: 3.1" material="shader: flat; src: #logo; transparent: true" position="0 10 -15" scale="1.3 1.3 1.3"></a-entity>

        <a-entity
          mixin="slice"
          slice9="color: #111; height: 4.8; width: 12.5"
          text="color: #6D6; value: GUNTERS.\nINSIDE THE OASIS\nLIES HIDDEN AN EGG\nWHOEVER FINDS THE EGG\nWILL INHERIT HALF A HUNDRED DOLLARS\n~; width: 12; wrapCount: 35; xOffset: 0.1; zOffset: 0.1" position="12 10 -9" look-at="#camera"></a-entity>
      {% endif %}

      <a-entity id="cameraRig">
        <a-camera id="camera" look-controls position="0 1.6 0" networked="template: #avatarTemplate; showLocalTemplate: false"></a-camera>

        <!-- Primary hand. -->
        <a-entity id="primaryHandContainer">
          <a-entity id="primaryHand" mixin="hand" hand-controls="right"></a-entity>
        </a-entity>

        <!-- Secondary hand. -->
        <a-entity id="secondaryHandContainer">
          <a-entity id="secondaryHand" mixin="hand" hand-controls="left"></a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="portals"
        mixin="hoverAnimation"
        {% if IS_HOME %}layout="type: circle; radius: 10; plane: xz" position="0 1.6 0"{% endif %}>
          {% for link in links %}
            {{ portal(link.zone.name, link.zone.url, link.zone.sectorType,
                      not IS_HOME and link.position, ROOT) }}
          {% endfor %}

          {% if not IS_HOME %}
            {{ portal('Start Zone', '../index.html', 'tron', '-2 0 3', ROOT) }}
            {{ portal('Previous Zone', '', sectorType, '2 0 3', ROOT, true) }}
          {% endif %}
      </a-entity>

      <a-entity id="portalShadows"
        {% if IS_HOME %}layout="type: circle; radius: 10; plane: xz"{% endif %}
        position="0 0.05 0">
          {% for link in links %}
            <a-entity
              geometry="primitive: plane; width: 2; height: 2"
              material="src: #shadowImg; shader: flat; transparent: true"
              rotation="-90 0 0"
              {% if not IS_HOME %}position="{{ link.position }}"{% endif %}></a-entity>
          {% endfor %}
      </a-entity>

      {% if not IS_PRODUCTION %}
        <a-entity id="mouseCursor" cursor="rayOrigin: mouse" raycaster="objects: [raycastable]" debug-cursor></a-entity>
      {% endif %}

      {% if hasHint %}
        <a-entity obj-model="obj: {{ ROOT }}assets/models/chest/model.obj; mtl: {{ ROOT }}assets/models/chest/materials.mtl" position="0 0.5 -4" hint="inThisSector: {{ inThisSector }}"></a-entity>
      {% endif %}

      {% if IS_GOAL %}
        {% include "./templates/goal.html" %}
      {% endif %}
    </a-scene>
  </body>
</html>
